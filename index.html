<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0"> 
    <title>Markdown and LaTeX Formatter & Downloader (v64 - Minimized PDF Size & Table Fix) üöÄ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">

    <script>
        MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- General and Layout Styling --- */
        body { 
            font-family: 'Noto Sans Devanagari', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f4f4f4; 
            color: #333; 
            min-width: 1200px; 
        }
        h1 { text-align: center; color: #333; }
        .container { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            max-width: 1200px; 
            margin: 20px auto; 
        }
        .panel { 
            width: 100%; 
            padding: 15px; 
            background-color: #fff; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
            border-radius: 8px; 
            box-sizing: border-box;
        }
        
        #markdown-input {
            width: 100%;
            height: 400px; 
            border: 1px solid #ccc;
            padding: 15px;
            box-sizing: border-box;
            font-size: 16px; 
            line-height: 1.6; 
            resize: vertical; 
            background-color: #fafafa; 
            font-family: Consolas, "Courier New", monospace; 
        }

        .page-view-panel {
            box-shadow: none !important; 
            background-color: transparent !important; 
            padding: 0 !important;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* --- Strict A4 Size and 10mm Margin for each page --- */
        .A4-page {
            width: 21cm; 
            height: 29.7cm; 
            margin: 15px 0; 
            overflow: hidden; 
            border: 1px solid #ccc; 
            padding: 10mm; 
            box-sizing: border-box;
            background-color: white; 
            color: #000000; 
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            display: flow-root; 
        }
        
        /* General Content Styling */
        .A4-page * {
            text-align: initial; 
            hyphens: auto; 
            color: #000000; 
        }
        
        .A4-page p {
            text-align: justify; 
            margin-bottom: 1em; 
        }
        
        /* --- Table Styling FIX --- */
        .A4-page table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            /* FIX: Allow table layout to be determined by content, improving rendering */
            table-layout: auto; 
            page-break-inside: avoid; 
        }
        .A4-page th, .A4-page td {
            border: 1px solid #000000;
            padding: 8px;
            text-align: left;
            /* FIX: Ensure word wrapping is normal */
            word-wrap: normal; 
        }
        .A4-page th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* Formula Placeholder Styling */
        .A4-page .formula-placeholder {
            font-weight: bold;
            color: #cc0000; 
            border: 1px solid #ffcccc;
            padding: 2px 5px;
            display: inline-block;
            margin: 0 5px;
        }
        
        #download-btn {
            display: block;
            width: 350px; 
            margin: 10px auto;
            padding: 10px 20px;
            background-color: #d9534f; 
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        #download-btn:hover { background-color: #c9302c; }
    </style>
</head>
<body>
    <h1>Markdown and LaTeX Formatter & Downloader (v64 - Minimized PDF Size & Table Fix) üöÄ</h1>
    <p style="text-align: center; color: #555;">**Latest update (v64)**: PDF capture scale reduced to **2** for minimum file size and corrected Table rendering.</p>
    
    <div class="container">
        <div class="panel" id="input-panel">
            <h2>Input (Write Markdown Code Here)</h2>
            <textarea id="markdown-input" oninput="updatePreview()">
## V64 - Table and Minimized PDF Size Test

‡§Ø‡§π ‡§µ‡§∞‡•ç‡§ú‡§º‡§® ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§ú‡§π‡§æ‡§Å ‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§´‡§º‡•â‡§∞‡•ç‡§Æ‡•Ç‡§≤‡§æ ‡§π‡•ã‡§ó‡§æ, ‡§µ‡§π‡§æ‡§Å ‡§ï‡•á‡§µ‡§≤ **(-Formula-)** ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡§æ, ‡§î‡§∞ PDF ‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§æ‡§á‡§ú‡§º ‡§ï‡§Æ ‡§∞‡§π‡•á‡§ó‡§æ‡•§

### 1. Mathematical Formula (Replaced)
‡§Ü‡§á‡§Ç‡§∏‡•ç‡§ü‡•Ä‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∏‡§ø‡§¶‡•ç‡§ß ‡§ä‡§∞‡•ç‡§ú‡§æ-‡§¶‡•ç‡§∞‡§µ‡•ç‡§Ø‡§Æ‡§æ‡§® ‡§∏‡§Æ‡•Ä‡§ï‡§∞‡§£:
$E = mc^2$

‡§¨‡•á‡§≤ ‡§∏‡•ç‡§ü‡•á‡§ü‡•ç‡§∏ (Bell States) ‡§ï‡§æ ‡§è‡§ï ‡§≤‡§Ç‡§¨‡§æ ‡§´‡§º‡•â‡§∞‡•ç‡§Æ‡•Ç‡§≤‡§æ (‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§Æ‡•ã‡§°):
$$ \mathcal{H} = \sum_{\langle i, j \rangle} \mathbf{J}_{ij} (\mathbf{S}_i \cdot \mathbf{S}_j) + \sum_{i} \mathbf{h}_i \cdot \mathbf{S}_i $$

### 2. Table Example (Corrected Rendering)
| ‡§Æ‡§π‡•Ä‡§®‡§æ | ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (‡§≤‡§æ‡§ñ ‚Çπ) | ‡§≤‡§æ‡§≠ (%) | ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä (‡§≤‡§Ç‡§¨‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü) |
| :--- | :---: | ---: | :--- |
| ‡§ú‡§®‡§µ‡§∞‡•Ä | 500 | 15% | ‡§Ø‡§π ‡§è‡§ï ‡§≤‡§Ç‡§¨‡•Ä ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä ‡§π‡•à ‡§ú‡•ã ‡§Ø‡§π ‡§ú‡§æ‡§Ç‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à ‡§ï‡§ø ‡§ü‡•á‡§¨‡§≤ ‡§∏‡§π‡•Ä ‡§¢‡§Ç‡§ó ‡§∏‡•á ‡§ì‡§µ‡§∞‡§´‡§º‡•ç‡§≤‡•ã ‡§ï‡•ã ‡§∏‡§Ç‡§≠‡§æ‡§≤‡§§‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç‡•§ |
| ‡§´‡§∞‡§µ‡§∞‡•Ä | 650 | 18% | ‡§∏‡§æ‡§ß‡§æ‡§∞‡§£ ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä‡•§ |
| ‡§Æ‡§æ‡§∞‡•ç‡§ö | 480 | 12% | ‡§õ‡•ã‡§ü‡•Ä ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä‡•§ |

### 3. Bullet Point Test 
* ‡§Ø‡§π ‡§™‡§π‡§≤‡§æ ‡§¨‡•Å‡§≤‡•á‡§ü ‡§™‡•â‡§á‡§Ç‡§ü ‡§π‡•à‡•§
* ‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§¨‡•Å‡§≤‡•á‡§ü ‡§™‡•â‡§á‡§Ç‡§ü‡•§
* ‡§§‡•Ä‡§∏‡§∞‡§æ ‡§¨‡•Å‡§≤‡•á‡§ü ‡§™‡•â‡§á‡§Ç‡§ü, ‡§ú‡§ø‡§∏‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§è‡§ï ‡§î‡§∞ ‡§á‡§®‡§≤‡§æ‡§á‡§® ‡§´‡§º‡•â‡§∞‡•ç‡§Æ‡•Ç‡§≤‡§æ ‡§π‡•à $A = \pi r^2$, ‡§ú‡•ã ‡§≠‡•Ä ‡§¨‡§¶‡§≤ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§
            </textarea>
        </div>
        
        <button id="download-btn" onclick="downloadPDF()">‚¨áÔ∏è Download as PDF (Minimum Size)</button>
        
        <div class="page-view-panel" id="output-panel">
            <h2>Output (Formatted A4 Page View - Auto Break)</h2>
            </div>
    </div>

    <script>
        const SAFE_A4_CONTENT_HEIGHT_PX = 1122; 
        const ELEMENT_NODE = 1; 
        const PLACEHOLDER_TEXT = '<span class="formula-placeholder">(-Formula-)</span>';

        /**
         * Replaces all common LaTeX/MathJax delimiters in the input with the placeholder text.
         */
        function replaceFormulas(markdown) {
            // Replaces $$...$$, \\[...\\] (Display Math)
            markdown = markdown.replace(/((?<!\\)\$\$(.|\n)*?(?<!\\)\$\$)/g, PLACEHOLDER_TEXT);
            markdown = markdown.replace(/((?<!\\)\\\\\[(.|\n)*?(?<!\\)\\\\\])/g, PLACEHOLDER_TEXT);

            // Replaces $...$ (Inline Math)
            markdown = markdown.replace(/((?<!\\)\$(?!\$)(.|\n)*?(?<!\\)\$)/g, PLACEHOLDER_TEXT);
            // Replaces \(...\) (Inline Math)
            markdown = markdown.replace(/((?<!\\)\\\((.|\n)*?(?<!\\)\\\))/g, PLACEHOLDER_TEXT);

            return markdown;
        }


        function createNewA4Page(outputPanel) {
            const newPage = document.createElement('div');
            newPage.className = 'A4-page';
            newPage.id = 'page-' + Math.random().toString(36).substr(2, 9); 
            outputPanel.appendChild(newPage);
            return newPage;
        }

        async function updatePreview() {
            const markdownInput = document.getElementById('markdown-input').value;
            const outputPanel = document.getElementById('output-panel');
            
            outputPanel.innerHTML = '<h2>Output (Formatted A4 Page View - Auto Break)</h2>'; 
            
            // 1. Replace formulas
            const filteredMarkdown = replaceFormulas(markdownInput);

            const fullHtmlContent = marked.parse(filteredMarkdown, { 
                sanitize: false,
                gfm: true, 
                breaks: true,
            });
            
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = fullHtmlContent;
            
            // 2. Element filtering (to remove text nodes/comments)
            const tempNodes = Array.from(tempContainer.childNodes).filter(node => node.nodeType === ELEMENT_NODE);
            
            tempContainer.innerHTML = '';
            tempNodes.forEach(node => tempContainer.appendChild(node));


            let currentPage = createNewA4Page(outputPanel);

            // 3. Page Breaking Logic
            const nodes = Array.from(tempContainer.children); 

            for (const node of nodes) {
                
                const clone = node.cloneNode(true);
                currentPage.appendChild(clone);
                
                if (currentPage.scrollHeight > SAFE_A4_CONTENT_HEIGHT_PX) {
                    
                    currentPage.removeChild(clone); 
                    currentPage = createNewA4Page(outputPanel);
                    currentPage.appendChild(node.cloneNode(true)); 
                } 
            }
            
            tempContainer.remove(); 
        }
        
        // --- PDF Download function (Minimum Resolution Screenshot) ---
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            
            const outputPanel = document.getElementById('output-panel');

            // CRITICAL: Clone the LIVE output panel
            const tempOutputPanel = outputPanel.cloneNode(true); 
            tempOutputPanel.style.position = 'absolute';
            tempOutputPanel.style.left = '-9999px'; 
            document.body.appendChild(tempOutputPanel);
            
            const pages = tempOutputPanel.querySelectorAll('.A4-page');

            if (pages.length === 0) {
                tempOutputPanel.remove();
                return;
            }

            const downloadBtn = document.getElementById('download-btn');
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'GENERATING PDF (Minimum Size)...';

            const pdf = new jsPDF('p', 'pt', 'a4'); 
            const PDF_WIDTH_PT = 595.28; 
            const PDF_HEIGHT_PT = 841.89; 
            const PDF_MARGIN_PT = 20; 
            const CONTENT_WIDTH_PT = PDF_WIDTH_PT - (PDF_MARGIN_PT * 2);
            const CONTENT_HEIGHT_PT = PDF_HEIGHT_PT - (PDF_MARGIN_PT * 2);

            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                
                if (i > 0) {
                    pdf.addPage();
                }

                // CRITICAL CHANGE: Scale reduced to 2 for smallest file size and fastest download
                const canvas = await html2canvas(page, {
                    scale: 2, 
                    useCORS: true,
                    width: page.clientWidth, 
                    height: page.clientHeight, 
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.8); // Changed to JPEG with reduced quality for smaller size
                
                // Add the image to the PDF
                pdf.addImage(imgData, 'JPEG', // Changed to JPEG
                    PDF_MARGIN_PT, PDF_MARGIN_PT, 
                    CONTENT_WIDTH_PT, CONTENT_HEIGHT_PT
                ); 
            }
            
            pdf.save("Formatted_Document_v64_Minimized.pdf");

            // Clean up the temporary panel
            tempOutputPanel.remove(); 
            
            downloadBtn.disabled = false;
            downloadBtn.textContent = '‚¨áÔ∏è Download as PDF (Minimum Size)';
        }

        // Initial render on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updatePreview, 100); 
        });
    </script>
</body>
</html>
